import requests
from bs4 import BeautifulSoup
import base64
import xml.etree.ElementTree as ET
import urllib3

# === CONFIGURATION ===
SP_URL = "https://ton-sp.example.com/"      # URL protÃ©gÃ©e par SAML (le Service Provider)
USERNAME = "alice"                          # Identifiant Keycloak
PASSWORD = "mot_de_passe"                   # Mot de passe Keycloak
TARGET_ATTR = "username"                    # Attribut Ã  utiliser comme identifiant (ex: "email")

# === DÃ‰SACTIVATION DES ALERTES SSL ===
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# === SESSION HTTP ===
session = requests.Session()

print("ğŸ” AccÃ¨s initial Ã  la ressource protÃ©gÃ©e...")
r1 = session.get(SP_URL, verify=False)
soup1 = BeautifulSoup(r1.text, 'html.parser')

form1 = soup1.find('form')
if not form1:
    raise RuntimeError("âŒ Aucun formulaire SAMLRequest trouvÃ© (Ã©tape 1)")

action1 = form1.get('action')
data1 = {i.get('name'): i.get('value', '') for i in form1.find_all('input') if i.get('name')}

print("â¡ï¸ Redirection vers lâ€™IdP (Keycloak)...")
r2 = session.post(action1, data=data1, verify=False)
soup2 = BeautifulSoup(r2.text, 'html.parser')

form2 = soup2.find('form')
if not form2:
    raise RuntimeError("âŒ Aucun formulaire de login trouvÃ© (Ã©tape 2)")

login_url = form2.get('action')
login_data = {i.get('name'): i.get('value', '') for i in form2.find_all('input') if i.get('name')}
login_data['username'] = USERNAME
login_data['password'] = PASSWORD

print("ğŸ”‘ Envoi des identifiants Ã  Keycloak...")
r3 = session.post(login_url, data=login_data, verify=False)
soup3 = BeautifulSoup(r3.text, 'html.parser')

form3 = soup3.find('form')
if not form3:
    raise RuntimeError("âŒ Aucun formulaire SAMLResponse trouvÃ© (Ã©tape 3)")

# Si Keycloak renvoie une page "Continue", on la traite
if not form3.find('input', {'name': 'SAMLResponse'}):
    print("â³ Formulaire intermÃ©diaire dÃ©tectÃ© (probablement 'Continue')...")
    action_inter = form3.get('action')
    data_inter = {i.get('name'): i.get('value', '') for i in form3.find_all('input') if i.get('name')}
    r3b = session.post(action_inter, data=data_inter, verify=False)
    soup3 = BeautifulSoup(r3b.text, 'html.parser')
    form3 = soup3.find('form')

if not form3:
    raise RuntimeError("âŒ Toujours aucun formulaire final avec SAMLResponse trouvÃ©.")

final_action = form3.get('action')
final_inputs = {
    i.get('name'): i.get('value', '') for i in form3.find_all('input') if i.get('name')
}

if 'SAMLResponse' not in final_inputs:
    print("\nğŸ§¾ Formulaire HTML reÃ§u :")
    print(form3.prettify()[:2000])
    raise RuntimeError("âŒ Champ SAMLResponse manquant. Authentification incomplÃ¨te.")

print("\nâœ… Champs extraits pour POST final au SP :")
for k, v in final_inputs.items():
    print(f"{k} = {v[:80]}{'...' if len(v) > 80 else ''}")

# Envoi de la rÃ©ponse SAML au SP
print("ğŸ“¤ Envoi de la rÃ©ponse SAML au SP...")
r4 = session.post(final_action, data=final_inputs, verify=False)

print("\nâœ… RÃ©ponse finale du SP :", r4.status_code)
print(r4.text[:500])

# === DÃ‰CODAGE SAMLResponse ET EXTRACTION D'ATTRIBUTS ===
print("\nğŸ” DÃ©codage et analyse de la SAMLResponse...")

saml_xml = base64.b64decode(final_inputs['SAMLResponse'])
root = ET.fromstring(saml_xml)
ns = {'saml2': 'urn:oasis:names:tc:SAML:2.0:assertion'}

# Affiche tous les attributs
print("\nğŸ“¦ Attributs SAML disponibles :")
for attr in root.findall('.//saml2:AttributeStatement/saml2:Attribute', ns):
    name = attr.attrib.get("Name", "(inconnu)")
    value = attr.find('saml2:AttributeValue', ns)
    if value is not None:
        print(f"- {name} = {value.text}")

# Extraction du MELLON_USER Ã  partir de l'attribut choisi
print("\nğŸ‘¤ Extraction du MELLON_USER depuis l'attribut SAML choisi...")
found = False
for attr in root.findall('.//saml2:AttributeStatement/saml2:Attribute', ns):
    name = attr.attrib.get("Name", "")
    if name == TARGET_ATTR:
        value = attr.find('saml2:AttributeValue', ns)
        if value is not None:
            print(f"ğŸ‘¤ MELLON_USER (via attribut '{TARGET_ATTR}') :", value.text)
            found = True

if not found:
    print(f"âŒ Attribut '{TARGET_ATTR}' non trouvÃ© dans la rÃ©ponse SAML.")








import requests
from bs4 import BeautifulSoup
import base64
import xml.etree.ElementTree as ET
import urllib3

# === CONFIGURATION ===
SP_URL = "https://ton-sp.example.com/"       # URL protÃ©gÃ©e par SAML
USERNAME = "alice"                           # Identifiant Keycloak
PASSWORD = "mot_de_passe"                    # Mot de passe Keycloak
TARGET_ATTR = "username"                     # Attribut SAML Ã  extraire comme identifiant

# === DÃ‰SACTIVER LES ALERTES SSL AUTOSIGNÃ‰ES ===
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

session = requests.Session()

print("ğŸ” AccÃ¨s Ã  la ressource protÃ©gÃ©e...")
r1 = session.get(SP_URL, verify=False)
soup1 = BeautifulSoup(r1.text, 'html.parser')
form1 = soup1.find('form')
if not form1:
    raise RuntimeError("âŒ Aucun formulaire SAMLRequest trouvÃ© (Ã©tape 1)")

action1 = form1.get('action')
data1 = {i.get('name'): i.get('value', '') for i in form1.find_all('input') if i.get('name')}

print("â¡ï¸ Redirection vers Keycloak...")
r2 = session.post(action1, data=data1, verify=False)
soup2 = BeautifulSoup(r2.text, 'html.parser')
form2 = soup2.find('form')
if not form2:
    raise RuntimeError("âŒ Aucun formulaire de login trouvÃ© (Ã©tape 2)")

login_url = form2.get('action')
login_data = {i.get('name'): i.get('value', '') for i in form2.find_all('input') if i.get('name')}
login_data['username'] = USERNAME
login_data['password'] = PASSWORD

print("ğŸ”‘ Authentification utilisateur...")
r3 = session.post(login_url, data=login_data, verify=False)
soup3 = BeautifulSoup(r3.text, 'html.parser')
form3 = soup3.find('form')
if not form3:
    raise RuntimeError("âŒ Aucun formulaire reÃ§u aprÃ¨s le login Keycloak.")

# === Ã‰tape intermÃ©diaire : formulaire "Continue" exÃ©cutÃ© normalement par JavaScript ===
if not form3.find('input', {'name': 'SAMLResponse'}):
    print("â³ Formulaire intermÃ©diaire dÃ©tectÃ©, simulation du form.submit()...")
    action_inter = form3.get('action')
    data_inter = {i.get('name'): i.get('value', '') for i in form3.find_all('input') if i.get('name')}
    r3b = session.post(action_inter, data=data_inter, verify=False)
    soup3 = BeautifulSoup(r3b.text, 'html.parser')
    form3 = soup3.find('form')

if not form3:
    raise RuntimeError("âŒ Toujours aucun formulaire SAMLResponse trouvÃ©.")

# === Extraction de la SAMLResponse ===
final_action = form3.get('action')
final_inputs = {i.get('name'): i.get('value', '') for i in form3.find_all('input') if i.get('name')}

if 'SAMLResponse' not in final_inputs:
    print("\nğŸ§¾ Formulaire HTML reÃ§u sans SAMLResponse :")
    print(form3.prettify()[:2000])
    raise RuntimeError("âŒ Champ SAMLResponse manquant. Authentification incomplÃ¨te.")

print("\nâœ… Champs extraits pour POST final vers le SP :")
for k, v in final_inputs.items():
    print(f"{k} = {v[:80]}{'...' if len(v) > 80 else ''}")

print("ğŸ“¤ Envoi de la SAMLResponse au SP final...")
r4 = session.post(final_action, data=final_inputs, verify=False)
print("\nâœ… RÃ©ponse finale du SP :", r4.status_code)
print(r4.text[:500])  # Affiche le dÃ©but de la page protÃ©gÃ©e

# === DÃ‰CODAGE DE LA SAMLResponse ET EXTRACTION Dâ€™ATTRIBUTS ===
print("\nğŸ” DÃ©codage de la SAMLResponse...")
saml_xml = base64.b64decode(final_inputs['SAMLResponse'])
root = ET.fromstring(saml_xml)
ns = {'saml2': 'urn:oasis:names:tc:SAML:2.0:assertion'}

# Liste tous les attributs disponibles
print("\nğŸ“¦ Attributs SAML disponibles :")
for attr in root.findall('.//saml2:AttributeStatement/saml2:Attribute', ns):
    name = attr.attrib.get("Name", "(inconnu)")
    values = attr.findall('saml2:AttributeValue', ns)
    for v in values:
        print(f"- {name} = {v.text}")

# Extraction du MELLON_USER (Ã  partir de lâ€™attribut cible)
print("\nğŸ‘¤ Extraction du MELLON_USER basÃ© sur lâ€™attribut :", TARGET_ATTR)
found = False
for attr in root.findall('.//saml2:AttributeStatement/saml2:Attribute', ns):
    if attr.attrib.get("Name") == TARGET_ATTR:
        value = attr.find('saml2:AttributeValue', ns)
        if value is not None:
            print(f"ğŸ‘¤ MELLON_USER = {value.text}")
            found = True
if not found:
    print(f"âŒ Attribut '{TARGET_ATTR}' non trouvÃ©.")
